name: GNU GCC intrinsic test cases compilation
on:
  schedule:
  - cron: "0 18 * * 0-6"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Prerequisites
        run:
          sudo apt-get install autoconf automake autotools-dev curl python3 python3-pip
          libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf
          libtool patchutils bc zlib1g-dev libexpat-dev ninja-build git cmake libglib2.0-dev
          dejagnu
      - name: Download GCC
        run: |
          cd ..
          rm -rf riscv-gnu-toolchain
          git clone --recursive https://github.com/riscv-collab/riscv-gnu-toolchain.git
          cd ./riscv-gnu-toolchain/gcc
          git remote update
          git reset --hard origin/master
      - name: Run auto generated test cases
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          cd ../riscv-gnu-toolchain
          ./configure --prefix="$PWD/install" \
            --with-arch=rv64gcv \
            --with-abi=lp64d \
            --with-isa-spec=20191213 \
            --with-sim=qemu
          mkdir -p gcc/gcc/testsuite/gcc.target/riscv/rvv/gcc-auto-generated/gnu-api-tests
          mkdir -p gcc/gcc/testsuite/gcc.target/riscv/rvv/gcc-auto-generated/policy_funcs/gnu-api-tests
          cp ../rvv-intrinsic-doc/gcc-auto-generated.exp gcc/gcc/testsuite/gcc.target/riscv/rvv/gcc-auto-generated/auto-generated.exp
          cp -r ../rvv-intrinsic-doc/auto-generated/gnu-api-tests/* gcc/gcc/testsuite/gcc.target/riscv/rvv/gcc-auto-generated/gnu-api-tests/
          cp -r ../rvv-intrinsic-doc/auto-generated/policy_funcs/gnu-api-tests/* \
          gcc/gcc/testsuite/gcc.target/riscv/rvv/gcc-auto-generated/policy_funcs/gnu-api-tests/

          mkdir -p gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/gnu-api-tests
          mkdir -p gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/policy_funcs/gnu-api-tests
          mkdir -p gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/gnu-overloaded-tests
          mkdir -p gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/policy_funcs/gnu-overloaded-tests
          cp ../rvv-intrinsic-doc/g++-auto-generated.exp gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/auto-generated.exp
          cp -r ../rvv-intrinsic-doc/auto-generated/gnu-api-tests/* \
          gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/gnu-api-tests/
          cp -r ../rvv-intrinsic-doc/auto-generated/policy_funcs/gnu-api-tests/* \
          gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/policy_funcs/gnu-api-tests/
          cp -r ../rvv-intrinsic-doc/auto-generated/gnu-overloaded-tests/* \
          gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/gnu-overloaded-tests/
          cp -r ../rvv-intrinsic-doc/auto-generated/policy_funcs/gnu-overloaded-tests/* \
          gcc/gcc/testsuite/g++.target/riscv/rvv/g++-auto-generated/policy_funcs/gnu-overloaded-tests/

          make report -j $(nproc) RUNTESTFLAGS="auto-generated.exp"
      - name: Check gcc result
        run: |
          tail -n 17 ../riscv-gnu-toolchain/build-gcc-newlib-stage2/gcc/testsuite/gcc/gcc.log
      - name: Check g++ result
        run: |
          tail -n 27 ../riscv-gnu-toolchain/build-gcc-newlib-stage2/gcc/testsuite/g++/g++.log
